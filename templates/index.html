{% extends "base.html" %}

{% block title %}Mapa de Salas - SENAI Morvan Figueiredo{% endblock %}

{% block content %}
<div class="container">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h1><i class="fas fa-map me-2 text-primary"></i>Mapa de Salas</h1>
                <div class="btn-group" role="group">
                    <a href="{{ url_for('available_now') }}" class="btn btn-success">
                        <i class="fas fa-clock me-2"></i>Salas Disponíveis Agora
                    </a>
                    <a href="{{ url_for('dashboard') }}" class="btn btn-outline-primary">
                        <i class="fas fa-tachometer-alt me-2"></i>Dashboard
                    </a>
                    {% if session.admin_authenticated %}
                    <a href="{{ url_for('generate_general_report_route') }}" class="btn btn-outline-success">
                        <i class="fas fa-file-pdf me-2"></i>Relatório Geral
                    </a>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Filters -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="fas fa-filter me-2"></i>Filtros</h5>
                </div>
                <div class="card-body">
                    <div class="row g-3">
                        <div class="col-md-3">
                            <label class="form-label">Bloco</label>
                            <input type="text" class="form-control" id="filterBlock" placeholder="Digite o bloco (ex: A, B1, Lab)">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Professor</label>
                            <input type="text" class="form-control" id="filterInstructor" placeholder="Nome do professor">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Software</label>
                            <input type="text" class="form-control" id="filterSoftware" placeholder="Software instalado">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Curso</label>
                            <input type="text" class="form-control" id="filterCourse" placeholder="Nome do curso">
                        </div>
                        <div class="col-md-3">
                            <label class="form-label">Computadores</label>
                            <select class="form-select" id="filterComputers">
                                <option value="">Todos</option>
                                <option value="true">Com computadores</option>
                                <option value="false">Sem computadores</option>
                            </select>
                        </div>
                    </div>
                    <div class="row g-3 mt-2">
                        <div class="col-md-4">
                            <label class="form-label">Capacidade</label>
                            <select class="form-select" id="filterCapacity">
                                <option value="">Qualquer capacidade</option>
                                <option value="small">Até 20 alunos</option>
                                <option value="medium">21-30 alunos</option>
                                <option value="large">Mais de 30 alunos</option>
                            </select>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-primary mt-4" id="applyFilters">
                                <i class="fas fa-search me-2"></i>Aplicar Filtros
                            </button>
                        </div>
                        <div class="col-md-4">
                            <button type="button" class="btn btn-outline-secondary mt-4" id="clearFilters">
                                <i class="fas fa-eraser me-2"></i>Limpar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Classrooms Grid -->
    <div class="row" id="classroomsGrid">
        {% for classroom in classrooms %}
        <div class="col-lg-4 col-md-6 mb-4 classroom-card" 
             data-block="{{ classroom.block|lower }}" 
             data-computers="{{ classroom.has_computers|lower }}"
             data-capacity="{{ classroom.capacity }}"
             data-software="{{ classroom.software|lower }}"
             data-courses="{% for schedule in classroom.schedules if schedule.is_active %}{{ schedule.course_name|lower }} {% endfor %}"
             data-instructors="{% for schedule in classroom.schedules %}{{ schedule.instructor|lower }} {% endfor %}">
            <div class="card h-100 clean-card">
                {% if classroom.image_filename %}
                {% if classroom.image_data %}
                <img src="{{ url_for('serve_image', classroom_id=classroom.id) }}" class="classroom-image" alt="{{ classroom.name }}">
                {% else %}
                <div class="no-image-placeholder d-flex align-items-center justify-content-center">
                    <i class="fas fa-image text-muted fa-2x"></i>
                </div>
                {% endif %}
                {% else %}
                <div class="classroom-image-placeholder">
                    <i class="fas fa-door-open"></i>
                </div>
                {% endif %}
                <div class="card-body p-3">
                    <div class="d-flex justify-content-between align-items-start mb-3">
                        <div>
                            <h5 class="card-title mb-1">{{ classroom.name }}</h5>
                            <small class="text-muted">{{ classroom.block }} • {{ classroom.capacity }} alunos</small>
                        </div>
                        {% if classroom.has_computers %}
                        <i class="fas fa-desktop text-success" title="Com computadores"></i>
                        {% endif %}
                    </div>
                    
                    {% if classroom.software %}
                    <div class="mb-2">
                        <div class="text-truncate small text-muted">{{ classroom.software }}</div>
                    </div>
                    {% endif %}
                    
                    <div class="d-flex justify-content-between align-items-center mt-auto">
                        <a href="{{ url_for('classroom_detail', classroom_id=classroom.id) }}" class="btn btn-sm btn-primary">
                            <i class="fas fa-eye me-1"></i>Ver
                        </a>
                        <div class="btn-group btn-group-sm">
                            <a href="{{ url_for('generate_pdf', classroom_id=classroom.id) }}" class="btn btn-outline-secondary btn-sm" title="PDF">
                                <i class="fas fa-file-pdf"></i>
                            </a>
                            <a href="{{ url_for('generate_qr', classroom_id=classroom.id) }}" class="btn btn-outline-secondary btn-sm" title="QR Code">
                                <i class="fas fa-qrcode"></i>
                            </a>
                            {% if session.admin_authenticated %}
                            <a href="{{ url_for('edit_classroom', classroom_id=classroom.id) }}" class="btn btn-outline-warning btn-sm" title="Editar">
                                <i class="fas fa-edit"></i>
                            </a>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if not classrooms %}
    <div class="row">
        <div class="col-12">
            <div class="text-center py-5">
                <i class="fas fa-exclamation-triangle fa-3x text-warning mb-3"></i>
                <h3>Nenhuma sala cadastrada</h3>
                <p class="text-muted">Não há salas cadastradas no sistema.</p>
                {% if session.admin_authenticated %}
                <a href="{{ url_for('add_classroom') }}" class="btn btn-primary">
                    <i class="fas fa-plus me-2"></i>Cadastrar Nova Sala
                </a>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}

{% block scripts %}
<script>
// Filter functionality
function filterClassrooms() {
    const filterBlock = document.getElementById('filterBlock').value.toLowerCase();
    const filterInstructor = document.getElementById('filterInstructor').value.toLowerCase();
    const filterSoftware = document.getElementById('filterSoftware').value.toLowerCase();
    const filterCourse = document.getElementById('filterCourse').value.toLowerCase();
    const filterComputers = document.getElementById('filterComputers').value;
    const filterCapacity = document.getElementById('filterCapacity').value;
    
    const cards = document.querySelectorAll('.classroom-card');
    let visibleCount = 0;
    
    cards.forEach(card => {
        let show = true;
        
        // Block filter (partial match)
        if (filterBlock && !card.dataset.block.includes(filterBlock)) {
            show = false;
        }
        
        // Instructor filter (partial match)
        if (filterInstructor && !card.dataset.instructors.includes(filterInstructor)) {
            show = false;
        }
        
        // Software filter (partial match)
        if (filterSoftware && !card.dataset.software.includes(filterSoftware)) {
            show = false;
        }

        // Course filter (partial match)
        if (filterCourse && !card.dataset.courses.includes(filterCourse)) {
            show = false;
        }
        
        // Computers filter
        if (filterComputers && card.dataset.computers !== filterComputers) {
            show = false;
        }
        
        // Capacity filter
        if (filterCapacity) {
            const capacity = parseInt(card.dataset.capacity);
            if (filterCapacity === 'small' && capacity > 20) show = false;
            if (filterCapacity === 'medium' && (capacity <= 20 || capacity > 30)) show = false;
            if (filterCapacity === 'large' && capacity <= 30) show = false;
        }
        
        card.style.display = show ? 'block' : 'none';
        if (show) visibleCount++;
    });
    
    // Show results count
    console.log(`Showing ${visibleCount} of ${cards.length} classrooms`);
}

function clearFilters() {
    document.getElementById('filterBlock').value = '';
    document.getElementById('filterInstructor').value = '';
    document.getElementById('filterSoftware').value = '';
    document.getElementById('filterCourse').value = '';
    document.getElementById('filterComputers').value = '';
    document.getElementById('filterCapacity').value = '';
    filterClassrooms();
}

// Add event listeners to filters (with null checks)
const applyBtn = document.getElementById('applyFilters');
const clearBtn = document.getElementById('clearFilters');
const filterBlockEl = document.getElementById('filterBlock');
const filterInstructorEl = document.getElementById('filterInstructor');
const filterSoftwareEl = document.getElementById('filterSoftware');
const filterCourseEl = document.getElementById('filterCourse');
const filterComputersEl = document.getElementById('filterComputers');
const filterCapacityEl = document.getElementById('filterCapacity');

if (applyBtn) applyBtn.addEventListener('click', filterClassrooms);
if (clearBtn) clearBtn.addEventListener('click', clearFilters);
if (filterBlockEl) filterBlockEl.addEventListener('input', filterClassrooms);
if (filterInstructorEl) filterInstructorEl.addEventListener('input', filterClassrooms);
if (filterSoftwareEl) filterSoftwareEl.addEventListener('input', filterClassrooms);
if (filterCourseEl) filterCourseEl.addEventListener('input', filterClassrooms);
if (filterComputersEl) filterComputersEl.addEventListener('change', filterClassrooms);
if (filterCapacityEl) filterCapacityEl.addEventListener('change', filterClassrooms);
</script>
{% endblock %}
